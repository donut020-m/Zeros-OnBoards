<!DOCTYPE html>
<html>
<head>
    <title>Industrial Revolution Experience</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            background: #2b1b17;
            overflow: hidden;
            touch-action: none;
            font-family: 'Georgia', serif;
        }
        canvas { display: block; }
        
        .ui-element {
            background: rgba(43, 27, 23, 0.95);
            color: #d4a559;
            border: 2px solid #8b4513;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        #dialog {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px;
            max-width: 80%;
            text-align: center;
            z-index: 100;
            display: none;
        }

        #machine-info {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            padding: 20px;
            max-width: 300px;
            z-index: 100;
            display: none;
        }

        #machine-info h3 {
            margin-top: 0;
            color: #ffd700;
        }

        #instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 15px;
            z-index: 100;
        }

        #interaction-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            z-index: 100;
            display: none;
            font-size: 1.2em;
            text-align: center;
        }

        #mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: none;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            margin: 5px;
            background: rgba(43, 27, 23, 0.7);
            color: #d4a559;
            border: 1px solid #8b4513;
            border-radius: 5px;
            font-size: 1.5em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="dialog" class="ui-element"></div>
    <div id="machine-info" class="ui-element">
        <h3>Machine Information</h3>
        <div id="machine-description"></div>
    </div>
    <div id="instructions" class="ui-element">
        Desktop: WASD to move, E to interact with inventors<br>
        Press SPACE near machines to learn about them<br>
        Mobile: Use on-screen controls
    </div>
    <div id="interaction-prompt" class="ui-element">
        Press SPACE to examine
    </div>
    <div id="mobile-controls">
        <div class="control-row">
            <button class="control-btn" id="btn-up">↑</button>
        </div>
        <div class="control-row">
            <button class="control-btn" id="btn-left">←</button>
            <button class="control-btn" id="btn-down">↓</button>
            <button class="control-btn" id="btn-right">→</button>
        </div>
        <button class="control-btn" id="btn-interact">E</button>
        <button class="control-btn" id="btn-space">□</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Scene setup
        const scene = new THREE.Scene();
        
        // Camera setup
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 15);
        
        // Renderer setup
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Create loader
        const loader = new THREE.TextureLoader();

        // Create skybox/background
        const bgTexture = loader.load('images/.png');
        scene.background = bgTexture;

        // Create floor with texture
        const floorGeometry = new THREE.PlaneGeometry(50, 50);
        const floorTexture = loader.load('images/floor.png');
        floorTexture.wrapS = THREE.RepeatWrapping;
        floorTexture.wrapT = THREE.RepeatWrapping;
        floorTexture.repeat.set(5, 5);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            map: floorTexture,
            side: THREE.DoubleSide
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Machine information database with image paths
        const machineInfo = {
            'spinning-jenny': {
                name: "Spinning Jenny",
                description: "Invented by James Hargreaves in 1764, this revolutionary device could spin multiple spools of thread simultaneously, dramatically increasing textile production efficiency. It allowed a single worker to operate eight spindles at once.",
                inventor: "James Hargreaves",
                year: 1764,
                inventorPosition: new THREE.Vector3(10, 0, 10),
                machineImage: 'images/spinningjenny.png',
                inventorImage: 'images/james.png'
            },
            'steam-engine': {
                name: "Improved Steam Engine",
                description: "James Watt's enhanced steam engine design introduced the separate condenser in 1769, greatly improving efficiency. This innovation was crucial to powering the Industrial Revolution, making steam power practical for factories and mills.",
                inventor: "James Watt",
                year: 1769,
                inventorPosition: new THREE.Vector3(-10, 0, 10),
                machineImage: 'images/steamengine.png',
                inventorImage: 'images/jameswatt.png'
            },
            'power-loom': {
                name: "Power Loom",
                description: "Edmund Cartwright's power loom, first patented in 1785, mechanized the weaving process. This invention completed the automation of textile production when combined with spinning innovations.",
                inventor: "Edmund Cartwright",
                year: 1785,
                inventorPosition: new THREE.Vector3(10, 0, -10),
                machineImage: 'images/powerloom.png',
                inventorImage: 'images/edmund.png'
            },
            'water-frame': {
                name: "Water Frame",
                description: "Richard Arkwright's water frame, patented in 1769, produced a stronger thread than the spinning jenny. It was the first machine to successfully spin cotton into yarn strong enough for warp threads.",
                inventor: "Richard Arkwright",
                year: 1769,
                inventorPosition: new THREE.Vector3(-10, 0, -10),
                machineImage: 'images/waterframe.png',
                inventorImage: 'images/richard.png'
            }
        };

        // Create machine with specific image
        function createMachine(type, position) {
            const group = new THREE.Group();
            const info = machineInfo[type];
            
            // Create a machine with specific image
            const machineGeometry = new THREE.PlaneGeometry(3, 4);
            const machineTexture = loader.load(info.machineImage);
            const machineMaterial = new THREE.MeshStandardMaterial({ 
                map: machineTexture,
                transparent: true,
                side: THREE.DoubleSide
            });
            
            const machineMesh = new THREE.Mesh(machineGeometry, machineMaterial);
            machineMesh.position.y = 2;
            machineMesh.rotation.y = Math.random() * Math.PI; // Random rotation for variety
            group.add(machineMesh);
            
            // Add a base platform
            const baseGeometry = new THREE.BoxGeometry(3.5, 0.5, 3.5);
            const baseMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.y = -0.25;
            base.receiveShadow = true;
            group.add(base);
            
            // Position the entire machine group
            group.position.copy(position);
            group.userData = { 
                type: type, 
                info: machineInfo[type],
                highlight: false
            };
            
            return group;
        }
        
        // Create inventor with specific image
        function createInventor(info) {
            const group = new THREE.Group();
            
            // Create inventor with specific image
            const inventorGeometry = new THREE.PlaneGeometry(2, 4);
            const inventorTexture = loader.load(info.inventorImage);
            const inventorMaterial = new THREE.MeshStandardMaterial({ 
                map: inventorTexture, 
                transparent: true,
                side: THREE.DoubleSide
            });
            
            const inventorMesh = new THREE.Mesh(inventorGeometry, inventorMaterial);
            inventorMesh.position.y = 2;
            group.add(inventorMesh);
            
            // Create name plate
            const plateGeometry = new THREE.PlaneGeometry(2.2, 0.5);
            const plateMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xd4a559
            });
            const namePlate = new THREE.Mesh(plateGeometry, plateMaterial);
            namePlate.position.set(0, 0.25, 0.1);
            group.add(namePlate);
            
            // Position the entire inventor group
            group.position.copy(info.inventorPosition);
            group.lookAt(new THREE.Vector3(0, 0, 0)); // Make inventors face center
            group.userData = { 
                type: 'inventor',
                info: info,
                highlight: false
            };
            
            return group;
        }

        // Create player character with image
        function createPlayer() {
            const group = new THREE.Group();
            
            // Create player with specific image
            const playerGeometry = new THREE.PlaneGeometry(1.5, 3);
            const playerTexture = loader.load('images/jameswatt.png');
            const playerMaterial = new THREE.MeshStandardMaterial({ 
                map: playerTexture,
                transparent: true,
                side: THREE.DoubleSide
            });
            
            const playerMesh = new THREE.Mesh(playerGeometry, playerMaterial);
            playerMesh.position.y = 1.5;
            group.add(playerMesh);
            
            // Add a shadow caster at the bottom of the player
            const shadowGeometry = new THREE.CircleGeometry(0.5, 16);
            const shadowMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x000000,
                transparent: true,
                opacity: 0.3
            });
            const shadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.y = 0.01; // Just above ground
            group.add(shadow);
            
            group.position.set(0, 0, 0);
            return group;
        }

        // Create machines
        const machines = [
            createMachine('spinning-jenny', new THREE.Vector3(8, 0, 8)),
            createMachine('steam-engine', new THREE.Vector3(-8, 0, 8)),
            createMachine('power-loom', new THREE.Vector3(8, 0, -8)),
            createMachine('water-frame', new THREE.Vector3(-8, 0, -8))
        ];
        machines.forEach(machine => scene.add(machine));
        
        // Create inventors
        const inventors = [];
        for (const [key, info] of Object.entries(machineInfo)) {
            const inventor = createInventor(info);
            inventors.push(inventor);
            scene.add(inventor);
        }
        
        // Create player
        const player = createPlayer();
        scene.add(player);

        // Controls setup
        const keys = {};
        document.addEventListener('keydown', (e) => { keys[e.key.toLowerCase()] = true; });
        document.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });

        // Mobile controls
        const mobileControls = document.getElementById('mobile-controls');
        let isMobile = false;

        function checkMobile() {
            isMobile = window.innerWidth <= 768;
            mobileControls.style.display = isMobile ? 'block' : 'none';
        }
        window.addEventListener('resize', checkMobile);
        checkMobile();

        // Setup mobile controls
        document.getElementById('btn-up').addEventListener('touchstart', () => keys['w'] = true);
        document.getElementById('btn-up').addEventListener('touchend', () => keys['w'] = false);
        document.getElementById('btn-down').addEventListener('touchstart', () => keys['s'] = true);
        document.getElementById('btn-down').addEventListener('touchend', () => keys['s'] = false);
        document.getElementById('btn-left').addEventListener('touchstart', () => keys['a'] = true);
        document.getElementById('btn-left').addEventListener('touchend', () => keys['a'] = false);
        document.getElementById('btn-right').addEventListener('touchstart', () => keys['d'] = true);
        document.getElementById('btn-right').addEventListener('touchend', () => keys['d'] = false);
        document.getElementById('btn-interact').addEventListener('touchstart', () => keys['e'] = true);
        document.getElementById('btn-interact').addEventListener('touchend', () => keys['e'] = false);
        document.getElementById('btn-space').addEventListener('touchstart', () => keys[' '] = true);
        document.getElementById('btn-space').addEventListener('touchend', () => keys[' '] = false);

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Player movement function
        function movePlayer() {
            const moveSpeed = 0.15;
            const rotationSpeed = 0.1;
            let moved = false;
            
            if (keys['w']) {
                player.position.z -= moveSpeed;
                moved = true;
            }
            if (keys['s']) {
                player.position.z += moveSpeed;
                moved = true;
            }
            if (keys['a']) {
                player.position.x -= moveSpeed;
                player.rotation.y += rotationSpeed;
                moved = true;
            }
            if (keys['d']) {
                player.position.x += moveSpeed;
                player.rotation.y -= rotationSpeed;
                moved = true;
            }
            
            // Update camera to follow player
            camera.position.x = player.position.x;
            camera.position.z = player.position.z + 15;
            camera.lookAt(player.position.x, player.position.y + 2, player.position.z);
            
            return moved;
        }

        // Machine interaction function
        function checkMachineInteraction() {
            const interactionPrompt = document.getElementById('interaction-prompt');
            const machineInfoPanel = document.getElementById('machine-info');
            const machineDescription = document.getElementById('machine-description');
            
            let nearMachine = false;
            machines.forEach(machine => {
                const distance = player.position.distanceTo(machine.position);
                if (distance < 4) {
                    nearMachine = true;
                    interactionPrompt.style.display = 'block';
                    
                    if (keys[' ']) { // Space key
                        const info = machine.userData.info;
                        machineDescription.innerHTML = `
                            <h4>${info.name} (${info.year})</h4>
                            <p><em>Invented by ${info.inventor}</em></p>
                            <p>${info.description}</p>
                        `;
                        machineInfoPanel.style.display = 'block';
                        
                        // Highlight the machine
                        machine.userData.highlight = true;
                    }
                }
            });
            
            if (!nearMachine) {
                interactionPrompt.style.display = 'none';
                machineInfoPanel.style.display = 'none';
                
                // Remove all highlights
                machines.forEach(machine => {
                    machine.userData.highlight = false;
                });
            }
        }
        
        // Inventor interaction function
        function checkInventorInteraction() {
            const dialogElement = document.getElementById('dialog');
            
            let nearInventor = false;
            let currentInventor = null;
            
            inventors.forEach(inventor => {
                const distance = player.position.distanceTo(inventor.position);
                if (distance < 3) {
                    nearInventor = true;
                    currentInventor = inventor;
                    
                    // Show interaction prompt
                    document.getElementById('interaction-prompt').style.display = 'block';
                    document.getElementById('interaction-prompt').innerText = 'Press E to talk';
                    
                    if (keys['e']) {
                        const info = inventor.userData.info;
                        dialogElement.innerHTML = `
                            <h3>${info.inventor}</h3>
                            <p>"Welcome! I am the inventor of the ${info.name} in ${info.year}. 
                            Would you like to learn more about my invention?"</p>
                        `;
                        dialogElement.style.display = 'block';
                        
                        // Highlight the inventor
                        inventor.userData.highlight = true;
                    }
                }
            });
            
            if (!nearInventor) {
                dialogElement.style.display = 'none';
                
                // Remove all inventor highlights
                inventors.forEach(inventor => {
                    inventor.userData.highlight = false;
                });
                
                // Reset interaction prompt if not near machine
                if (document.getElementById('interaction-prompt').innerText === 'Press E to talk') {
                    document.getElementById('interaction-prompt').style.display = 'none';
                    document.getElementById('interaction-prompt').innerText = 'Press SPACE to examine';
                }
            }
        }

        // Highlight effect for objects
        function updateHighlights() {
            const time = Date.now() * 0.001; // Get time for pulsing effect
            const pulseScale = 1 + 0.1 * Math.sin(time * 4);
            
            // Update machine highlights
            machines.forEach(machine => {
                if (machine.userData.highlight) {
                    machine.scale.set(pulseScale, pulseScale, pulseScale);
                    // Add a glowing outline effect if needed
                } else {
                    machine.scale.set(1, 1, 1);
                }
            });
            
            // Update inventor highlights
            inventors.forEach(inventor => {
                if (inventor.userData.highlight) {
                    inventor.scale.set(pulseScale, pulseScale, pulseScale);
                } else {
                    inventor.scale.set(1, 1, 1);
                }
            });
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Handle player movement
            const playerMoved = movePlayer();
            
            // Check for interactions
            checkMachineInteraction();
            checkInventorInteraction();
            
            // Update visual highlights
            updateHighlights();
            
            // Add some idle animation to the player if not moving
            if (!playerMoved) {
                player.children[0].position.y = 1.5 + 0.05 * Math.sin(Date.now() * 0.002);
            }
            
            // Add subtle movement to all machines
            machines.forEach(machine => {
                machine.rotation.y += 0.001;
            });

            renderer.render(scene, camera);
        }

        // Start the animation loop
        animate();
    </script>
</body>
</html>